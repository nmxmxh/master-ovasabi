# PostgreSQL 18 Optimized Configuration for OVASABI High-Concurrency Go Environment

# ------------------------------------------------------------------------------
# CONNECTIONS & AUTHENTICATION
# ------------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 200                   # Matches your client-side pool setting
superuser_reserved_connections = 10     # Reserve connections for superuser

# ------------------------------------------------------------------------------
# RESOURCE USAGE (MEMORY)
# Assumes a container with ~8GB of RAM. Adjust if different.
# ------------------------------------------------------------------------------
shared_buffers = 2GB                    # 25% of system RAM is a good start
effective_cache_size = 6GB              # 75% of system RAM for the planner
work_mem = 16MB                         # Increased for sorts, joins, and hash tables
maintenance_work_mem = 256MB            # For VACUUM, CREATE INDEX, etc.
huge_pages = try                        # Use huge pages for memory management if available

# ------------------------------------------------------------------------------
# PARALLELISM
# Crucial for leveraging Go's concurrency for analytical queries.
# Assumes a container with ~4 CPU cores.
# ------------------------------------------------------------------------------
max_worker_processes = 8                # Total workers (parallel + autovacuum + etc.)
max_parallel_workers_per_gather = 4     # Max workers per query node
max_parallel_workers = 8                # Max workers for parallel queries
parallel_leader_participation = on      # Use the leader process for work as well

# ------------------------------------------------------------------------------
# QUERY TUNING & PLANNING
# ------------------------------------------------------------------------------
random_page_cost = 1.1                  # Lower for SSDs/NVMe
seq_page_cost = 1.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025
default_statistics_target = 100         # Increase for more accurate query plans

# ------------------------------------------------------------------------------
# WRITE-AHEAD LOG (WAL)
# ------------------------------------------------------------------------------
wal_level = replica
wal_buffers = 16MB                      # Default is -1 (1/32 of shared_buffers), 16MB is a solid explicit value
wal_writer_delay = 200ms
wal_compression = on                    # Compress full-page writes

# ------------------------------------------------------------------------------
# CHECKPOINTS
# ------------------------------------------------------------------------------
checkpoint_timeout = 15min              # Increase time between checkpoints
checkpoint_completion_target = 0.9      # Spread checkpoint I/O over time
max_wal_size = 2GB                      # Increase from default 1GB
min_wal_size = 1GB

# ------------------------------------------------------------------------------
# I/O & ASYNC BEHAVIOR
# ------------------------------------------------------------------------------
effective_io_concurrency = 200          # For modern SSDs/NVMe, higher is better
maintenance_io_concurrency = 50         # I/O for maintenance tasks
# io_method = 'io_uring'                # Uncomment for modern Linux kernels

# ------------------------------------------------------------------------------
# AUTOVACUUM
# More aggressive for high-write, high-update workloads.
# ------------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 6              # Increase number of workers
autovacuum_vacuum_scale_factor = 0.05   # Vacuum more frequently (5% of table)
autovacuum_analyze_scale_factor = 0.02  # Analyze more frequently (2% of table)
autovacuum_vacuum_cost_delay = 10ms     # Allow autovacuum to use more resources
autovacuum_vacuum_cost_limit = 1000

# ------------------------------------------------------------------------------
# LOGGING & MONITORING
# ------------------------------------------------------------------------------
log_destination = 'stderr'
logging_collector = off
log_line_prefix = '%m [%p] %q%u@%d '
log_statement = 'ddl'                   # Log Data Definition Language statements
log_lock_waits = on
log_checkpoints = on
log_connections = on
log_disconnections = on
track_io_timing = on
track_wal_io_timing = on
track_functions = all
track_activity_query_size = 2048
timezone = 'UTC'
log_timezone = 'UTC'

# ------------------------------------------------------------------------------
# EXTENSIONS & LIBRARIES
# ------------------------------------------------------------------------------
shared_preload_libraries = 'pg_stat_statements,vector'
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# ------------------------------------------------------------------------------
# LOCALE
# ------------------------------------------------------------------------------
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'
