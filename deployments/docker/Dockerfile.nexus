# Dockerfile for the Nexus service, using the common go-builder.
# syntax=docker/dockerfile:1.4
# --- Build Stage ---
# Use the common builder stage which contains all source code and dependencies.
FROM ovasabi-go-builder:latest AS builder

# The working directory is /app, inherited from the builder.
# All source code is present, and protoc has been run.

# Build the Nexus binary.
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o /app/nexus ./cmd/nexus

# ----------- Final Stage (Distroless) -----------
FROM gcr.io/distroless/base-debian11

WORKDIR /nexus

# Copy the pre-downloaded health probe tool
COPY --from=builder /app/tools/grpc_health_probe /bin/grpc_health_probe


COPY --from=builder /app/nexus .
COPY --from=builder /app/config/service_registration.json /nexus/config/
COPY --from=builder /app/start/default_campaign.json /nexus/start/default_campaign.json

USER nonroot:nonroot

EXPOSE 50052 9090

ENTRYPOINT ["/nexus/nexus"]